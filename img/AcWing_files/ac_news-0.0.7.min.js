class AcNewsAttachmentPhoto{constructor(root,$attachment){this.root=root,this.$attachment=$attachment,this.$photo=$attachment.find(".attachment-photo"),this.$input=$attachment.find("#add-news-upload-image"),this.uploader=new AcNewsUploader(root),this.start()}start(){this.add_listening_events()}add_listening_events(){let outer=this;this.$input.change(function(e){outer.upload_files(e.target.files)});let $edit_field_all=this.root.edit_field.$edit_field_all;$edit_field_all.on("dragover",function(e){$edit_field_all.addClass("add-news-edit-field-all-drag-image"),e.preventDefault(),e.stopPropagation()}),$edit_field_all.on("dragenter",function(e){$edit_field_all.addClass("add-news-edit-field-all-drag-image"),e.preventDefault(),e.stopPropagation()}),$edit_field_all.on("dragleave",function(e){$edit_field_all.removeClass("add-news-edit-field-all-drag-image")}),$edit_field_all.on("drop",function(e){e.originalEvent.dataTransfer&&e.originalEvent.dataTransfer.files.length&&(e.preventDefault(),e.stopPropagation(),outer.upload_files(e.originalEvent.dataTransfer.files),$edit_field_all.removeClass("add-news-edit-field-all-drag-image"))})}upload_files(files){let cnt=0,cur_image_cnt=this.root.edit_field.photos.length,uploader=this.uploader.createUploader();for(let i=0;i<9-cur_image_cnt&&i<files.length;i++){let file=files[i],items=file.name.split("."),type=items[items.length-1];if(-1===jQuery.inArray(type.toLowerCase(),["png","jpg","jpeg","gif"]))continue;cnt++;let user_data='{"Vod":{}}';uploader.addFile(file,null,null,null,user_data)}cnt>0&&uploader.startUpload()}upload_image_success(image_url){this.root.edit_field.add_photo(image_url)}}class AcNewsUploader{constructor(root){this.root=root}createUploader(){let outer=this,image_url=null,uploader=new AliyunUpload.Vod({timeout:6e4,partSize:1048576,parallel:5,retryCount:3,retryDuration:2,region:"cn-shanghai",userId:"1940578407112055",addFileSuccess:function(uploadInfo){},onUploadstarted:function(uploadInfo){let file=uploadInfo.file,items=file.name.split("."),type=items[items.length-1],name=file.name.substr(0,file.name.length-type.length-1);$.ajax({type:"GET",data:{name,type,cate_id:1000145466},url:GLOBAL_NEWS.get_upload_image_info_url,dataType:"json",success:function(resp){if("success"===resp.error_message){let uploadAuth=resp.UploadAuth,uploadAddress=resp.UploadAddress,imageId=resp.ImageId;image_url=resp.ImageURL,uploader.setUploadAuthAndAddress(uploadInfo,uploadAuth,uploadAddress,imageId)}},error:function(resp){}})},onUploadSucceed:function(uploadInfo){outer.root.attachment.photo.upload_image_success(image_url)},onUploadFailed:function(uploadInfo,code,message){},onUploadCanceled:function(uploadInfo,code,message){},onUploadProgress:function(uploadInfo,totalSize,progress){},onUploadTokenExpired:function(uploadInfo){},onUploadEnd:function(uploadInfo){}});return uploader}}class AcNewsAttachment{constructor(root,$ac_news){this.root=root,this.$attachment=$ac_news.find(".add-news-attachment"),this.photo=new AcNewsAttachmentPhoto(root,this.$attachment)}}class AcNewsEditField{constructor(root,$ac_news){this.root=root,this.$edit_field_all=$ac_news.find(".add-news-edit-field-all"),this.$edit_field_authorization=$ac_news.find(".add-news-edit-field-authorization"),this.$edit_field=$ac_news.find(".add-news-edit-field"),this.$edit_field_photos=$ac_news.find(".add-news-edit-field-photos"),this.photos=[],this.start()}start(){this.fit_edit_field(),this.focus_after_show()}focus_after_show(){let outer=this;this.root.$ac_news.on("shown.bs.modal",function(){outer.$edit_field.focus()})}fit_edit_field(){let outer=this,font_size="big";this.$edit_field.bind("DOMSubtreeModified",function(){outer.$edit_field.html().length<=85?"small"===font_size&&(outer.$edit_field.css("font-size","24px"),font_size="big"):"big"===font_size&&(outer.$edit_field.css("font-size","15px"),font_size="small")})}adjust_image_size(){let cnt=this.photos.length,w=100;2===cnt||4===cnt?w/=2:1!==cnt&&(w/=3);for(let i=0;i<cnt;i++){let $img=this.photos[i].html;$img.width(w+"%"),$img.height($img.width())}}add_photo(image_url){let outer=this;AcNewsEditField.image_uuid++;let image={url:image_url,image_id:AcNewsEditField.image_uuid,html:$(`<div id="ac-news-edit-photos-${AcNewsEditField.image_uuid}" style="overflow: hidden; display: inline-block; float: left;">`+'<span class="glyphicon glyphicon-remove" style="top: 20px; right: 20px; cursor: pointer; float: right;"></span>'+`<img src="${image_url}" alt="照片" width="100%" height="100%" style="border-radius: 5px; object-fit: cover;">`+"</div>")};0===this.photos.length&&this.$edit_field.css("min-height","50px"),this.$edit_field_photos.append(image.html),this.photos.push(image),image.html.find("span").click(function(){let image_id=parseInt($(this).parent().attr("id").replace("ac-news-edit-photos-",""));for(let i=0;i<outer.photos.length;i++)if(outer.photos[i].image_id===image_id){outer.photos[i].html.remove(),outer.photos.splice(i,1),outer.adjust_image_size();break}}),this.adjust_image_size(),this.root.submit_btn.adjust_button_state()}get_authorization(){return this.$edit_field_authorization.find(":selected").val()}get_content(){return this.$edit_field.html()}get_photos(){let urls="";if(this.photos.length){urls=this.photos[0].url.split("?")[0];for(let i=1;i<this.photos.length;i++)urls+="\n"+this.photos[i].url.split("?")[0]}return urls}}AcNewsEditField.image_uuid=0;class AcNewsSubmitBtn{constructor(root,$ac_news){this.root=root,this.$submit_btn=$ac_news.find(".add-news-field-submit-btn"),this.start()}start(){this.add_events()}adjust_button_state(){let outer=this;outer.root.edit_field.$edit_field.html().length||outer.root.edit_field.photos.length?outer.$submit_btn.attr("disabled",!1):outer.$submit_btn.attr("disabled",!0)}add_events(){let outer=this;this.$submit_btn.click(function(){outer.create_a_news()}),this.root.edit_field.$edit_field.bind("DOMSubtreeModified",function(){outer.adjust_button_state()})}create_a_news(){let outer=this,edit_field=this.root.edit_field,authorization=edit_field.get_authorization(),content=edit_field.get_content(),photos=edit_field.get_photos();this.$submit_btn.val("发帖中..."),this.$submit_btn.attr("disabled",!0),$.ajax({type:"POST",url:GLOBAL_NEWS.add_url,data:{authorization,activity_id:GLOBAL_NEWS.activity_id,content,photos},dataType:"json",success:function(resp){"success"===resp.error_message?(outer.$submit_btn.val("发帖成功"),outer.$submit_btn.attr("disabled",!0),location.reload()):(outer.$submit_btn.val("发帖"),outer.$submit_btn.attr("disabled",!1))},error:function(resp){outer.$submit_btn.val("发帖"),outer.$submit_btn.attr("disabled",!1)}})}}class AcNews{constructor(){this.$ac_news=$("#modal-add-news"),this.edit_field=new AcNewsEditField(this,this.$ac_news),this.submit_btn=new AcNewsSubmitBtn(this,this.$ac_news),this.attachment=new AcNewsAttachment(this,this.$ac_news)}}$(document).ready(function(){new AcNews});
